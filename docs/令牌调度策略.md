# 令牌调度策略

## 一、核心架构

```
┌─────────────────────────────────────────────────────┐
│                   令牌筒                                │
└─────────────────────────────────────────────────────┘
                          ↓
              ┌───────────────────────────────┐
              │    传令使 (每5分钟检查)        │
              └───────────────────────────────┘
                          ↓
              ┌───────────────────────────────┐
              │    解析令牌，提取任务类型        │
              └───────────────────────────────┘
                          ↓
              ┌───────────────────────────────┐
              │    按任务类型触发对应验收使       │
              └───────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│                   验收流水线                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │数据验收使│  │代码验收使│  │环境验收使│      │
│  └──────────┘  └──────────┘  └──────────┘      │
└─────────────────────────────────────────────────────┘
```

## 二、令牌状态流转

```
🔴 待接令 → 🔴 执行中 → 🔴 待验收 → ✅ 完成
```

### 状态说明

| 状态 | 说明 | 处理方式 |
|------|------|----------|
| 🔴 待接令 | 令牌刚创建 | 触发弟子执行 |
| 🔴 执行中 | 弟子执行中 | 等待完成或超时重试 |
| 🔴 待验收 | 产出完成 | 触发对应验收使 |
| ✅ 完成 | 验收通过 | 令牌闭环 |

## 三、任务类型映射

| 任务类型 | 验收使 | 适用弟子 |
|----------|--------|----------|
| 数据采集 | 数据验收使 | 风媒、硅谷通、开源客、模型侠、舆情通、视界通 |
| 技能开发 | 代码验收使 | 匠人、鲁班 |
| 环境安装 | 环境验收使 | 移动使、重启使 |
| 整改修复 | 整改验收使 | 所有弟子 |
| 调研分析 | 调研验收使 | 调研监控使、评书先生 |
| 系统运维 | 运维验收使 | 重启使、系统监控使 |

## 四、异常处理

### 执行失败
- 重试次数: 最多3次
- 重试间隔: 5分钟
- 3次失败后: 汇报暂停

### 验收失败
- 返回整改
- 整改完成后重新验收
- 连续3次失败: 汇报帮主

## 五、核心脚本

### parse_lingpai.sh
```bash
# 解析令牌文件
~/.cache/传令使/parse_lingpai.sh <令牌文件>

# 输出JSON格式
{
  "lingpai_id": "LINGPai_20260215_XXXX",
  "agent_id": "外务堂/模型侠",
  "task_type": "数据采集",
  "task_name": "任务名称",
  "retry_count": "0"
}
```

### trigger_acceptor.sh
```bash
# 触发验收使
~/.cache/传令使/trigger_acceptor.sh <lingpai_id> <task_type>
```

### update_status.sh
```bash
# 更新令牌状态
~/.cache/传令使/update_status.sh <lingpai_id> <status>
```

## 六、日志文件

| 文件 | 说明 |
|------|------|
| `~/.cache/传令使/executions.log` | 执行触发记录 |
| `~/.cache/传令使/acceptances.log` | 验收触发记录 |
| `~/.cache/传令使/closed.log` | 令牌闭环记录 |
| `~/.cache/传令使/failures.log` | 失败记录 |
